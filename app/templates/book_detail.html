<!DOCTYPE html>
<html lang="en" data-theme="{{ settings.theme if settings else 'light' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ book.title }} - FreeWise</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=Libre+Baskerville:wght@400;700&family=Crimson+Pro:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            darkMode: ['class', '[data-theme="dark"]'],
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Manrope', 'system-ui', '-apple-system', 'sans-serif'],
                        serif: ['Crimson Pro', 'Georgia', 'serif'],
                    },
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        .title-font {
            font-family: 'Libre Baskerville', 'Crimson Pro', Georgia, serif;
        }

        .htmx-indicator {
            display: none;
        }

        .htmx-request .htmx-indicator {
            display: block;
        }

        .cover-downloading #cover-download-indicator {
            display: block;
        }

        .cover-downloading #cover-search-results {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
    <!-- Back Button (Top Left) -->
    <div class="absolute top-6 left-6 z-10">
        <a href="/library/ui" class="flex items-center gap-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 transition-colors">
            <i data-lucide="arrow-left" class="w-5 h-5"></i>
            <span class="text-sm font-medium">Library</span>
        </a>
    </div>

    <!-- Content Wrapper for max-width and mobile compatibility -->
    <div class="max-w-2xl mx-auto px-4 py-20">
        <!-- Cover Section -->
        <div id="cover-section" class="mb-10">
            <div class="flex flex-col items-center gap-4">
                {% if book.cover_image_url %}
                    <div class="w-36 h-52 rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700 bg-gray-100 dark:bg-gray-800 flex items-center justify-center">
                        <img src="{{ book.cover_image_url }}" alt="Cover for {{ book.title }}" class="w-full h-full object-cover" />
                    </div>
                {% else %}
                    <div class="w-36 h-52 rounded-lg border border-dashed border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 flex flex-col items-center justify-center text-gray-400">
                        <i data-lucide="image" class="w-8 h-8 mb-2"></i>
                        <span class="text-xs">No cover</span>
                    </div>
                {% endif %}

                {% if book.cover_image_source %}
                    <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full">
                        {{ book.cover_image_source }}
                    </span>
                {% endif %}
            </div>

            <div class="mt-6 space-y-4">
                <form 
                    hx-post="/library/ui/book/{{ book.id }}/cover/upload"
                    hx-target="#cover-section"
                    hx-swap="outerHTML"
                    hx-encoding="multipart/form-data"
                    hx-indicator="#cover-upload-indicator"
                    class="flex flex-col sm:flex-row items-center justify-center gap-3">
                    <input 
                        type="file"
                        name="cover_file"
                        accept="image/jpeg,image/png,image/webp"
                        class="block w-full sm:w-auto text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-amber-50 file:text-amber-700 hover:file:bg-amber-100 dark:file:bg-gray-700 dark:file:text-gray-200"
                        required>
                    <button 
                        type="submit"
                        class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white text-sm font-medium rounded-md transition-colors">
                        Upload Cover
                    </button>
                </form>

                <div id="cover-upload-indicator" class="htmx-indicator">
                    <div class="h-2 w-full max-w-xs mx-auto bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                        <div class="h-full bg-amber-600 animate-pulse" style="width: 100%;"></div>
                    </div>
                    <div class="text-xs text-gray-500 dark:text-gray-400 text-center mt-1">Uploading...</div>
                </div>

                <form 
                    hx-post="/library/ui/book/{{ book.id }}/cover/search"
                    hx-target="#cover-search-results"
                    hx-swap="innerHTML"
                    class="flex flex-col sm:flex-row items-center justify-center gap-3">
                    <input 
                        type="text"
                        name="query"
                        value="{{ book.title }}"
                        placeholder="Search Open Library"
                        class="w-full sm:w-80 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 text-sm">
                    <button 
                        type="submit"
                        class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-medium rounded-md transition-colors">
                        Search Covers
                    </button>
                </form>
            </div>

            <div id="cover-search-results" class="mt-6"></div>

            {% if book.cover_image_url %}
            <form 
                hx-post="/library/ui/book/{{ book.id }}/cover/delete"
                hx-target="#cover-section"
                hx-swap="outerHTML"
                class="flex items-center justify-center mt-4">
                <button 
                    type="submit"
                    class="px-4 py-2 bg-rose-600 hover:bg-rose-700 text-white text-sm font-medium rounded-md transition-colors">
                    Remove Cover
                </button>
            </form>
            {% endif %}

            <div id="cover-download-indicator" class="htmx-indicator mt-4">
                <div class="h-2 w-full max-w-xs mx-auto bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                    <div class="h-full bg-emerald-600 animate-pulse" style="width: 100%;"></div>
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400 text-center mt-1">Downloading cover...</div>
            </div>
        </div>

        <!-- Book Header (Centered, No Background) -->
        <div id="book-header" class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-3 title-font">
                {{ book.title }}
            </h1>
            
            {% if book.author %}
            <div class="text-lg text-gray-600 dark:text-gray-400 mb-6">
                by {{ book.author }}
            </div>
            {% endif %}
            
            {% set active_highlights = highlights | selectattr('is_discarded', 'equalto', false) | list %}
            {% set discarded_highlights = highlights | selectattr('is_discarded', 'equalto', true) | list %}
            
            <div class="mb-6 text-sm text-gray-600 dark:text-gray-400">
                <span class="font-semibold">{{ active_highlights|length }}</span> active highlight{{ 's' if active_highlights|length != 1 else '' }}
                {% if discarded_highlights %}
                    <span class="mx-2">|</span>
                    <span class="font-semibold">{{ discarded_highlights|length }}</span> discarded
                {% endif %}
            </div>
            
            <!-- Action Buttons (Edit/Delete) -->
            <div class="flex items-center justify-center gap-4 mb-6 pb-0">
                <button 
                    class="flex items-center gap-2 px-3 py-2 text-amber-700 dark:text-amber-400 hover:text-amber-800 dark:hover:text-amber-300 transition-colors"
                    hx-get="/library/ui/book/{{ book.id }}/edit"
                    hx-target="#book-header"
                    hx-swap="outerHTML"
                    title="Edit Book"
                    type="button">
                    <i data-lucide="pencil" class="w-4 h-4"></i>
                    <span class="text-xs font-medium">Edit</span>
                </button>
                <button 
                    class="flex items-center gap-2 px-3 py-2 text-rose-600 dark:text-rose-400 hover:text-rose-700 dark:hover:text-rose-300 transition-colors"
                    hx-delete="/library/ui/book/{{ book.id }}"
                    hx-confirm="⚠️ Are you sure you want to remove '{{ book.title }}' and all its {{ highlights|length }} highlight(s) from your library? This action cannot be undone."
                    title="Remove from Library"
                    type="button">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                    <span class="text-xs font-medium">Remove</span>
                </button>
            </div>
            
            <!-- Document Tags Section -->
            <div id="document-tags-section" class="mt-6">
                <div id="tags-list" class="flex flex-wrap gap-2 justify-center mb-3">
                    {% if book.document_tags %}
                        {% for tag in book.document_tags.split(',') %}
                        <div class="inline-flex items-center px-3 py-1.5 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-full text-sm">
                            <i data-lucide="tag" class="w-3 h-3 mr-1.5"></i>
                            <span>{{ tag.strip() }}</span>
                            <button 
                                class="ml-2 text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 transition-colors"
                                hx-post="/library/ui/book/{{ book.id }}/remove-tag"
                                hx-vals='{"tag": "{{ tag.strip() }}"}'
                                hx-target="#document-tags-section"
                                hx-swap="innerHTML"
                                title="Remove tag">
                                <i data-lucide="x" class="w-3 h-3"></i>
                            </button>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
                <div class="text-center">
                    <form 
                        hx-post="/library/ui/book/{{ book.id }}/add-tag"
                        hx-target="#document-tags-section"
                        hx-swap="innerHTML"
                        class="inline-flex items-center gap-2 px-3 py-2 bg-white dark:bg-gray-800 border border-dashed border-gray-300 dark:border-gray-600 rounded-full text-gray-600 dark:text-gray-400 hover:border-gray-400 dark:hover:border-gray-500 transition-colors">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        <input 
                            type="text"
                            name="new_tag"
                            placeholder="Add document tags"
                            class="bg-transparent focus:outline-none text-sm text-gray-700 dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-500"
                            autocomplete="off"
                        >
                        <button type="submit" class="text-xs font-medium text-amber-700 dark:text-amber-300 hover:text-amber-900 dark:hover:text-amber-100 transition-colors">Add</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Highlights Sections Wrapper -->
        <div id="highlights-sections-wrapper">
            <!-- Active Highlights List -->
            {% if active_highlights %}
            <div id="highlights-container" class="space-y-4">
                {% for highlight in active_highlights %}
                    {% include "_book_highlight.html" %}
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-12 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">
                <p class="text-xl font-medium text-gray-900 dark:text-white mb-2">No active highlights</p>
                <p class="text-gray-600 dark:text-gray-400">
                    {% if discarded_highlights %}
                        All highlights in this book have been discarded. See the discarded section below.
                    {% else %}
                        Import highlights to get started.
                    {% endif %}
                </p>
            </div>
            {% endif %}

            <!-- Discarded Highlights Section -->
            {% if discarded_highlights %}
            <div class="mt-12 pt-8 border-t-2 border-gray-200 dark:border-gray-700">
                <h2 class="flex items-center gap-2 mb-6 text-xl font-semibold text-gray-600 dark:text-gray-400">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                    <span>Discarded Highlights ({{ discarded_highlights|length }})</span>
                </h2>
                <div id="discarded-highlights-container" class="space-y-4 opacity-75">
                    {% for highlight in discarded_highlights %}
                        {% include "_book_highlight.html" %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        function initLucideIcons() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initLucideIcons);
        } else {
            initLucideIcons();
        }
        
        document.addEventListener('htmx:afterSwap', initLucideIcons);
        document.addEventListener('htmx:afterSettle', initLucideIcons);

        document.body.addEventListener('htmx:beforeRequest', function(evt) {
            const path = evt.detail && evt.detail.requestConfig ? evt.detail.requestConfig.path : '';
            if (path && path.includes('/cover/select')) {
                const coverSection = document.getElementById('cover-section');
                if (coverSection) {
                    coverSection.classList.add('cover-downloading');
                    const buttons = coverSection.querySelectorAll('button');
                    buttons.forEach(btn => btn.setAttribute('disabled', 'disabled'));
                }
            }
        });

        document.body.addEventListener('htmx:afterSwap', function(evt) {
            if (evt.detail && evt.detail.target && evt.detail.target.id === 'cover-section') {
                initLucideIcons();
            }
        });

        document.body.addEventListener('htmx:responseError', function(evt) {
            const path = evt.detail && evt.detail.requestConfig ? evt.detail.requestConfig.path : '';
            if (path && path.includes('/cover/select')) {
                const coverSection = document.getElementById('cover-section');
                if (coverSection) {
                    coverSection.classList.remove('cover-downloading');
                    const buttons = coverSection.querySelectorAll('button');
                    buttons.forEach(btn => btn.removeAttribute('disabled'));
                }

                const results = document.getElementById('cover-search-results');
                if (results && evt.detail && evt.detail.xhr && evt.detail.xhr.responseText) {
                    results.innerHTML = evt.detail.xhr.responseText;
                    results.style.display = 'block';
                }
            }
        });
    </script>
</body>
</html>
