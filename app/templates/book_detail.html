{% extends "base.html" %}

{% block title %}{{ book.title }} - FreeWise{% endblock %}

{% block heading %}{% endblock %}

{% block content %}
<!-- Content Wrapper for max-width and mobile compatibility -->
<div style="max-width: 600px; margin: 0 auto; padding: 0 15px;">
<!-- Book Header (Centered) -->
<div id="book-header" style="position: relative; text-align: center; margin-bottom: 30px; padding: 30px; background: var(--highlight-bg); border-radius: 8px; border: 1px solid var(--border-color);">
    <!-- Edit Button in Top-Left -->
    <button 
        style="position: absolute; top: 15px; left: 15px; background: transparent; border: none; color: #007bff; cursor: pointer; font-size: 20px; line-height: 1; padding: 5px; transition: transform 0.2s;"
        hx-get="/library/ui/book/{{ book.id }}/edit"
        hx-target="#book-header"
        hx-swap="outerHTML"
        title="Edit Book"
        type="button"
        onmouseover="this.style.transform='scale(1.2)'"
        onmouseout="this.style.transform='scale(1)'">
        ‚úèÔ∏è
    </button>
    
    <!-- Delete Button in Top-Right -->
    <button 
        style="position: absolute; top: 15px; right: 15px; background: transparent; border: none; color: #dc3545; cursor: pointer; font-size: 24px; line-height: 1; padding: 5px; transition: transform 0.2s;"
        hx-delete="/library/ui/book/{{ book.id }}"
        hx-confirm="‚ö†Ô∏è Are you sure you want to remove '{{ book.title }}' and all its {{ highlights|length }} highlight(s) from your library? This action cannot be undone."
        title="Remove from Library"
        type="button"
        onmouseover="this.style.transform='scale(1.2)'"
        onmouseout="this.style.transform='scale(1)'">
        ‚úï
    </button>
    
    <h1 style="margin: 0 0 15px 0; font-size: 2em; color: var(--text-color);">
        {{ book.title }}
    </h1>
    
    {% if book.author %}
    <div style="margin-bottom: 15px; font-size: 1.2em; color: var(--muted-text);">
        by {{ book.author }}
    </div>
    {% endif %}
    
    <!-- Document Tags Section -->
    <div id="document-tags-section" style="margin-top: 20px;">
        <div id="tags-list" style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 10px;">
            {% if book.document_tags %}
                {% for tag in book.document_tags.split(',') %}
                <div style="display: inline-flex; align-items: center; padding: 6px 12px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 20px;">
                    <span style="margin-right: 8px;">üè∑Ô∏è {{ tag.strip() }}</span>
                    <button 
                        style="background: transparent; border: none; cursor: pointer; color: #dc3545; padding: 0; font-size: 1.2em; line-height: 1;"
                        hx-post="/library/ui/book/{{ book.id }}/remove-tag"
                        hx-vals='{"tag": "{{ tag.strip() }}"}'
                        hx-target="#document-tags-section"
                        hx-swap="innerHTML"
                        title="Remove tag">
                        √ó
                    </button>
                </div>
                {% endfor %}
            {% endif %}
        </div>
        <div style="text-align: center;">
            <button 
                style="background: var(--bg-color); border: 1px dashed var(--border-color); padding: 8px 16px; border-radius: 20px; cursor: pointer; color: var(--muted-text);"
                hx-get="/library/ui/book/{{ book.id }}/add-tag"
                hx-target="#add-tag-form"
                hx-swap="innerHTML">
                + Add document tags
            </button>
        </div>
        <div id="add-tag-form" style="margin-top: 10px; text-align: center;"></div>
    </div>
    
    {% set active_highlights = highlights | selectattr('is_discarded', 'equalto', false) | list %}
    {% set discarded_highlights = highlights | selectattr('is_discarded', 'equalto', true) | list %}
    
    <div style="margin-top: 20px; color: var(--muted-text); font-size: 0.9em;">
        <strong>{{ active_highlights|length }}</strong> active highlight{{ 's' if active_highlights|length != 1 else '' }}
        {% if discarded_highlights %}
            | <strong>{{ discarded_highlights|length }}</strong> discarded
        {% endif %}
    </div>
</div>

<!-- Highlights Sections Wrapper -->
<div id="highlights-sections-wrapper">
    <!-- Active Highlights List -->
    {% if active_highlights %}
    <div id="highlights-container">
        {% for highlight in active_highlights %}
            {% include "_book_highlight.html" %}
        {% endfor %}
    </div>
    {% else %}
    <div style="text-align: center; padding: 40px; background: var(--highlight-bg); border-radius: 8px; border: 1px solid var(--border-color);">
        <p style="font-size: 1.2em; margin-bottom: 10px;">No active highlights</p>
        <p style="color: var(--muted-text);">{% if discarded_highlights %}All highlights in this book have been discarded. See the discarded section below.{% else %}Import highlights to get started.{% endif %}</p>
    </div>
    {% endif %}

    <!-- Discarded Highlights Section -->
    {% if discarded_highlights %}
    <div style="margin-top: 50px; padding-top: 30px; border-top: 2px solid var(--border-color);">
        <h2 style="margin-bottom: 20px; color: var(--muted-text); font-size: 1.3em;">
            üóëÔ∏è Discarded Highlights ({{ discarded_highlights|length }})
        </h2>
        <div id="discarded-highlights-container" style="opacity: 0.75;">
            {% for highlight in discarded_highlights %}
                {% include "_book_highlight.html" %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<div style="margin-top: 30px; text-align: center;">
    <a href="/library/ui">‚Üê Back to Library</a>
</div>
</div>
{% endblock %}
