{% extends "base.html" %}

{% block title %}Settings - FreeWise{% endblock %}

{% block heading %}Settings{% endblock %}

{% block content %}
{% if success_message %}
<div class="bg-green-50 dark:bg-green-900/20 border-l-4 border-green-500 p-4 mb-6 rounded">
    <div class="flex items-center gap-3">
        <i data-lucide="check-circle" class="w-5 h-5 text-green-600 dark:text-green-400"></i>
        <p class="text-green-700 dark:text-green-300">{{ success_message }}</p>
    </div>
</div>
{% endif %}

<!-- Settings Form -->
<form method="post" action="/settings/ui" class="max-w-2xl space-y-8">
    <!-- Daily Review Count Setting -->
    <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6">
        <div class="flex items-start gap-4">
            <div class="pt-1">
                <i data-lucide="zap" class="w-6 h-6 text-primary-600 dark:text-primary-400"></i>
            </div>
            <div class="flex-1">
                <label for="daily_review_count" class="block text-lg font-semibold text-gray-900 dark:text-white mb-2">
                    Daily Review Count
                </label>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                    Number of highlights to show in your daily review session
                </p>
                <input 
                    type="number" 
                    id="daily_review_count" 
                    name="daily_review_count" 
                    value="{{ settings.daily_review_count }}"
                    min="1"
                    max="50"
                    required
                    class="w-full max-w-xs px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
                <small class="text-xs text-gray-500 dark:text-gray-400 mt-2 block">
                    Minimum: 1 | Maximum: 50
                </small>
            </div>
        </div>
    </div>

    <!-- Theme Setting -->
    <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6">
        <div class="flex items-start gap-4">
            <div class="pt-1">
                <i data-lucide="palette" class="w-6 h-6 text-primary-600 dark:text-primary-400"></i>
            </div>
            <div class="flex-1">
                <label for="theme" class="block text-lg font-semibold text-gray-900 dark:text-white mb-2">
                    Theme
                </label>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                    Choose your preferred visual theme
                </p>
                <select 
                    id="theme" 
                    name="theme" 
                    required
                    class="w-full max-w-xs px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all">
                    <option value="light" {% if settings.theme == "light" %}selected{% endif %}>
                        Light
                    </option>
                    <option value="dark" {% if settings.theme == "dark" %}selected{% endif %}>
                        Dark
                    </option>
                    <option value="auto" {% if settings.theme == "auto" %}selected{% endif %}>
                        Auto (System)
                    </option>
                </select>
            </div>
        </div>
    </div>

    <!-- Save Button -->
    <div class="flex gap-3 pt-4">
        <button type="submit" class="flex items-center gap-2 bg-primary-600 hover:bg-primary-700 dark:bg-primary-600 dark:hover:bg-primary-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
            <i data-lucide="save" class="w-5 h-5"></i>
            <span>Save Settings</span>
        </button>
        <a href="/dashboard/ui" class="flex items-center gap-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-900 dark:text-white px-6 py-3 rounded-lg font-semibold transition-colors">
            <i data-lucide="x" class="w-5 h-5"></i>
            <span>Cancel</span>
        </a>
    </div>
</form>

<!-- Export Data Section -->
<div class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
    <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Export Data</h3>
    
    <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-8">
        <div class="flex items-start gap-4 mb-6">
            <div class="pt-1">
                <i data-lucide="download" class="w-6 h-6 text-primary-600 dark:text-primary-400"></i>
            </div>
            <div class="flex-1">
                <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
                    Download CSV Export
                </h4>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">
                    Download all your highlights and metadata as a CSV file. The export includes highlight text, notes, 
                    book information, tags, favorite/discard status, and timestamps.
                </p>

                <!-- Progress Bar (hidden by default) -->
                <div id="export-progress-container" style="display: none;" class="mb-6 p-5 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg">
                    <div class="text-center mb-4">
                        <i data-lucide="loader" class="w-8 h-8 mx-auto text-primary-600 dark:text-primary-400 animate-spin mb-3"></i>
                        <p class="font-semibold text-gray-900 dark:text-white">Exporting your highlights...</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Please wait while we generate your CSV file</p>
                    </div>
                    
                    <!-- Animated progress bar -->
                    <div class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                        <div id="export-progress-bar" class="h-full bg-gradient-to-r from-primary-500 to-primary-600 w-0 transition-all" style="transition: width 0.3s ease;"></div>
                    </div>
                    <p class="text-center mt-3 text-xs text-gray-500 dark:text-gray-400">
                        <span id="export-progress-text">Preparing export...</span>
                    </p>
                </div>

                <a href="/export/csv" 
                   id="export-btn"
                   onclick="showExportProgress(event)"
                   class="inline-flex items-center gap-2 bg-primary-600 hover:bg-primary-700 dark:bg-primary-600 dark:hover:bg-primary-700 text-white px-6 py-3 rounded-lg font-semibold transition-all hover:shadow-md">
                    <i data-lucide="download" class="w-5 h-5"></i>
                    <span>Download CSV Export</span>
                </a>
                
                <div class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                    <p class="text-xs text-blue-700 dark:text-blue-300 flex items-start gap-2">
                        <i data-lucide="info" class="w-4 h-4 mt-0.5 flex-shrink-0"></i>
                        <span><strong>Note:</strong> The exported CSV can be imported back into FreeWise or used with other tools. File format is compatible with standard spreadsheet applications.</span>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function showExportProgress(event) {
        // Don't prevent default - let the download happen
        
        // Disable button temporarily
        const exportBtn = document.getElementById('export-btn');
        exportBtn.style.opacity = '0.5';
        exportBtn.style.pointerEvents = 'none';
        
        // Show progress container
        document.getElementById('export-progress-container').style.display = 'block';
        
        // Simulate progress
        let progress = 0;
        const progressBar = document.getElementById('export-progress-bar');
        const progressText = document.getElementById('export-progress-text');
        
        const messages = [
            'Querying database...',
            'Collecting highlights...',
            'Processing book metadata...',
            'Formatting tags...',
            'Generating CSV...',
            'Download starting...'
        ];
        
        let messageIndex = 0;
        progressText.textContent = messages[0];
        
        const interval = setInterval(() => {
            progress += Math.random() * 20;
            if (progress > 100) progress = 100;
            
            progressBar.style.width = progress + '%';
            
            // Update message periodically
            if (progress > (messageIndex + 1) * 16 && messageIndex < messages.length - 1) {
                messageIndex++;
                progressText.textContent = messages[messageIndex];
            }
            
            // Complete and hide after reaching 100%
            if (progress >= 100) {
                clearInterval(interval);
                setTimeout(() => {
                    document.getElementById('export-progress-container').style.display = 'none';
                    progressBar.style.width = '0%';
                    exportBtn.style.opacity = '1';
                    exportBtn.style.pointerEvents = 'auto';
                }, 1000);
            }
        }, 200);
    }

    // Initialize Lucide icons
    document.addEventListener('DOMContentLoaded', lucide.createIcons);
</script>
{% endblock %}
