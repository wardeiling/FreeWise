{% extends "base.html" %}

{% block title %}Settings - FreeWise{% endblock %}

{% block heading %}Settings{% endblock %}

{% block content %}
{% if success_message %}
<div class="success-message" style="padding: 15px; border-radius: 4px; margin-bottom: 20px;">
    {{ success_message }}
</div>
{% endif %}

<form method="post" action="/settings/ui" style="max-width: 500px;">
    <div style="margin-bottom: 20px;">
        <label for="daily_review_count" style="display: block; margin-bottom: 5px; font-weight: bold;">
            Daily Review Count
        </label>
        <input 
            type="number" 
            id="daily_review_count" 
            name="daily_review_count" 
            value="{{ settings.daily_review_count }}"
            min="1"
            max="50"
            required
            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 1em;">
        <small style="display: block; margin-top: 5px;">
            Number of highlights to show in daily review (1-50)
        </small>
    </div>

    <div style="margin-bottom: 20px;">
        <label for="default_sort" style="display: block; margin-bottom: 5px; font-weight: bold;">
            Default Sort Order
        </label>
        <select 
            id="default_sort" 
            name="default_sort" 
            required
            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 1em;">
            <option value="next_review" {% if settings.default_sort == "next_review" %}selected{% endif %}>
                Next Review Date
            </option>
            <option value="created_at" {% if settings.default_sort == "created_at" %}selected{% endif %}>
                Creation Date
            </option>
            <option value="updated_at" {% if settings.default_sort == "updated_at" %}selected{% endif %}>
                Last Updated
            </option>
            <option value="favorite" {% if settings.default_sort == "favorite" %}selected{% endif %}>
                Favorites First
            </option>
        </select>
        <small style="display: block; margin-top: 5px;">
            How highlights are sorted in list views
        </small>
    </div>

    <div style="margin-bottom: 20px;">
        <label for="theme" style="display: block; margin-bottom: 5px; font-weight: bold;">
            Theme
        </label>
        <select 
            id="theme" 
            name="theme" 
            required
            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 1em;">
            <option value="light" {% if settings.theme == "light" %}selected{% endif %}>
                Light
            </option>
            <option value="dark" {% if settings.theme == "dark" %}selected{% endif %}>
                Dark
            </option>
            <option value="auto" {% if settings.theme == "auto" %}selected{% endif %}>
                Auto (System)
            </option>
        </select>
        <small style="display: block; margin-top: 5px;">
            Visual theme for the application
        </small>
    </div>

    <div style="margin-top: 30px;">
        <button type="submit" style="background: #28a745; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em;">
            üíæ Save Settings
        </button>
        <a href="/" style="margin-left: 15px;">
            Cancel
        </a>
    </div>
</form>

<!-- Export Section -->
<div style="margin-top: 50px; padding-top: 30px; border-top: 2px solid var(--border-color);">
    <h2 style="margin-bottom: 20px; color: var(--text-color);">üì• Export Data</h2>
    
    <div style="max-width: 500px; background: var(--highlight-bg); padding: 25px; border-radius: 8px; border: 1px solid var(--border-color);">
        <p style="margin: 0 0 20px 0; color: var(--muted-text); line-height: 1.6;">
            Download all your highlights and metadata as a CSV file. The export includes 
            highlight text, notes, book information, tags, favorite/discard status, and timestamps.
        </p>
        
        <!-- Progress Bar (hidden by default) -->
        <div id="export-progress-container" style="display: none; margin-bottom: 20px; padding: 20px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px;">
            <div style="text-align: center; margin-bottom: 15px;">
                <div style="font-size: 2em; margin-bottom: 10px;">üì§</div>
                <p style="margin: 0; font-weight: 600; color: var(--text-color);">Exporting your highlights...</p>
                <p style="margin: 5px 0 0 0; color: var(--muted-text); font-size: 0.9em;">Please wait while we generate your CSV file</p>
            </div>
            
            <!-- Animated progress bar -->
            <div style="width: 100%; height: 30px; background: var(--highlight-bg); border-radius: 15px; overflow: hidden; border: 1px solid var(--border-color); position: relative;">
                <div id="export-progress-bar" style="height: 100%; background: linear-gradient(90deg, #28a745, #1e7e34); width: 0%; transition: width 0.3s ease; position: relative;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); animation: shimmer 2s infinite;"></div>
                </div>
            </div>
            <p style="text-align: center; margin-top: 10px; color: var(--muted-text); font-size: 0.85em;">
                <span id="export-progress-text">Preparing export...</span>
            </p>
        </div>
        
        <a href="/export/csv" 
           id="export-btn"
           onclick="showExportProgress(event)"
           style="display: inline-block; background: var(--link-color); color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-size: 1em; font-weight: 500; transition: all 0.2s;"
           onmouseover="this.style.opacity='0.9'; this.style.transform='translateY(-2px)'"
           onmouseout="this.style.opacity='1'; this.style.transform='translateY(0)'">
            üì• Download CSV Export
        </a>
        
        <div style="margin-top: 20px; padding: 15px; background: var(--bg-color); border-radius: 4px; border-left: 4px solid var(--link-color);">
            <small style="color: var(--muted-text); line-height: 1.5;">
                <strong>Note:</strong> The exported CSV can be imported back into FreeWise or used with other tools. 
                File format is compatible with standard spreadsheet applications.
            </small>
        </div>
    </div>
</div>

<style>
    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }
</style>

<script>
    function showExportProgress(event) {
        // Don't prevent default - let the download happen
        
        // Disable button temporarily
        const exportBtn = document.getElementById('export-btn');
        exportBtn.style.opacity = '0.5';
        exportBtn.style.pointerEvents = 'none';
        
        // Show progress container
        document.getElementById('export-progress-container').style.display = 'block';
        
        // Simulate progress
        let progress = 0;
        const progressBar = document.getElementById('export-progress-bar');
        const progressText = document.getElementById('export-progress-text');
        
        const messages = [
            'Querying database...',
            'Collecting highlights...',
            'Processing book metadata...',
            'Formatting tags...',
            'Generating CSV...',
            'Download starting...'
        ];
        
        let messageIndex = 0;
        progressText.textContent = messages[0];
        
        const interval = setInterval(() => {
            progress += Math.random() * 20;
            if (progress > 100) progress = 100;
            
            progressBar.style.width = progress + '%';
            
            // Update message periodically
            if (progress > (messageIndex + 1) * 16 && messageIndex < messages.length - 1) {
                messageIndex++;
                progressText.textContent = messages[messageIndex];
            }
            
            // Complete and hide after reaching 100%
            if (progress >= 100) {
                clearInterval(interval);
                setTimeout(() => {
                    document.getElementById('export-progress-container').style.display = 'none';
                    progressBar.style.width = '0%';
                    exportBtn.style.opacity = '1';
                    exportBtn.style.pointerEvents = 'auto';
                }, 1000);
            }
        }, 200);
    }
</script>

<div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border-color);">
    <a href="/">‚Üê Back to Home</a>
</div>
{% endblock %}
