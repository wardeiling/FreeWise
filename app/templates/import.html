{% extends "base.html" %}

{% block title %}Import Highlights - FreeWise{% endblock %}

{% block heading %}Import from Readwise{% endblock %}

{% block content %}
{% if success_message %}
<div class="bg-green-50 dark:bg-green-900/20 border-l-4 border-green-500 p-4 mb-6 rounded">
    <div class="flex items-start gap-3">
        <i data-lucide="check-circle" class="w-5 h-5 text-green-600 dark:text-green-400 flex-shrink-0 mt-0.5"></i>
        <div>
            <p class="font-semibold text-green-700 dark:text-green-300 mb-2">Import Successful!</p>
            <p class="text-sm text-green-700 dark:text-green-300 mb-3">{{ success_message }}</p>
            <div class="flex gap-3">
                <a href="/highlights/ui/review" class="inline-flex items-center gap-2 text-sm text-green-700 dark:text-green-300 hover:text-green-900 dark:hover:text-green-100 font-medium transition-colors">
                    <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    <span>Review Highlights</span>
                </a>
                <a href="/import/ui" class="inline-flex items-center gap-2 text-sm text-green-700 dark:text-green-300 hover:text-green-900 dark:hover:text-green-100 font-medium transition-colors">
                    <i data-lucide="upload" class="w-4 h-4"></i>
                    <span>Import Another File</span>
                </a>
            </div>
            {% if skipped_rows %}
            <div class="mt-4 bg-white dark:bg-gray-900/40 border border-green-200 dark:border-green-800 rounded p-3">
                <div class="flex items-center gap-2 mb-2">
                    <i data-lucide="alert-triangle" class="w-4 h-4 text-amber-600 dark:text-amber-400"></i>
                    <span class="text-sm font-semibold text-green-800 dark:text-green-200">Skipped rows ({{ skipped_rows|length }})</span>
                </div>
                <div class="max-h-64 overflow-auto border border-gray-200 dark:border-gray-800 rounded">
                    <table class="min-w-full text-left text-xs text-gray-700 dark:text-gray-200">
                        <thead class="bg-gray-100 dark:bg-gray-800/70 text-gray-800 dark:text-gray-100">
                            <tr>
                                <th class="px-3 py-2">Row</th>
                                <th class="px-3 py-2">Reason</th>
                                <th class="px-3 py-2">Highlight</th>
                                <th class="px-3 py-2">Note</th>
                                <th class="px-3 py-2">Book</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in skipped_rows %}
                            <tr class="border-t border-gray-200 dark:border-gray-800">
                                <td class="px-3 py-2 align-top">{{ r.row }}</td>
                                <td class="px-3 py-2 align-top text-amber-700 dark:text-amber-300">{{ r.reason }}</td>
                                <td class="px-3 py-2 align-top">{{ r.highlight }}</td>
                                <td class="px-3 py-2 align-top">{{ r.note }}</td>
                                <td class="px-3 py-2 align-top">{{ r.book_title }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<div class="max-w-2xl">
    <p class="text-gray-600 dark:text-gray-400 mb-6">
        Upload a Readwise CSV export file to import your highlights into FreeWise.
    </p>
    
    <!-- How to Export Instructions -->
    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-6 mb-8">
        <div class="flex items-start gap-3 mb-4">
            <i data-lucide="info" class="w-5 h-5 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5"></i>
            <h3 class="text-lg font-semibold text-blue-900 dark:text-blue-100">How to export from Readwise:</h3>
        </div>
        <ol class="space-y-2 text-sm text-blue-800 dark:text-blue-200 ml-8">
            <li class="flex items-start gap-2">
                <span class="font-semibold">1.</span>
                <span>Log in to <a href="https://readwise.io" target="_blank" class="underline hover:text-blue-600 dark:hover:text-blue-300">readwise.io</a></span>
            </li>
            <li class="flex items-start gap-2">
                <span class="font-semibold">2.</span>
                <span>Go to Settings â†’ Export</span>
            </li>
            <li class="flex items-start gap-2">
                <span class="font-semibold">3.</span>
                <span>Click "Export" in the CSV block (at the bottom of the page)</span>
            </li>
            <li class="flex items-start gap-2">
                <span class="font-semibold">4.</span>
                <span>Save file to device</span>
            </li>
            <li class="flex items-start gap-2">
                <span class="font-semibold">5.</span>
                <span>Upload it here</span>
            </li>
        </ol>
    </div>

    <!-- Import Form -->
    <form method="post" action="/import/ui" enctype="multipart/form-data" id="import-form" onsubmit="showProgress()">
        <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6 mb-6">
            <div class="flex items-start gap-4 mb-4">
                <div class="pt-1">
                    <i data-lucide="file-text" class="w-6 h-6 text-primary-600 dark:text-primary-400"></i>
                </div>
                <div class="flex-1">
                    <label for="file" class="block text-lg font-semibold text-gray-900 dark:text-white mb-2">
                        Select CSV File
                    </label>
                    <input 
                        type="file" 
                        id="file" 
                        name="file" 
                        accept=".csv"
                        required
                        class="w-full px-4 py-3 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white cursor-pointer hover:border-primary-500 dark:hover:border-primary-400 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                </div>
            </div>
        </div>

        <!-- CSV Format Info -->
        <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 mb-6">
            <p class="text-sm font-semibold text-gray-900 dark:text-white mb-3">
                Expected CSV columns:
            </p>
            <ul class="space-y-2 text-sm text-gray-600 dark:text-gray-400">
                <li class="flex items-start gap-2">
                    <i data-lucide="check" class="w-4 h-4 text-green-600 dark:text-green-400 flex-shrink-0 mt-0.5"></i>
                    <span><strong class="text-gray-900 dark:text-white">Highlight</strong> (required) - The highlighted text</span>
                </li>
                <li class="flex items-start gap-2">
                    <i data-lucide="check" class="w-4 h-4 text-gray-400 dark:text-gray-600 flex-shrink-0 mt-0.5"></i>
                    <span><strong class="text-gray-900 dark:text-white">Book Title</strong> - Stored as source</span>
                </li>
                <li class="flex items-start gap-2">
                    <i data-lucide="check" class="w-4 h-4 text-gray-400 dark:text-gray-600 flex-shrink-0 mt-0.5"></i>
                    <span><strong class="text-gray-900 dark:text-white">Book Author</strong> - Stored separately</span>
                </li>
                <li class="flex items-start gap-2">
                    <i data-lucide="check" class="w-4 h-4 text-gray-400 dark:text-gray-600 flex-shrink-0 mt-0.5"></i>
                    <span><strong class="text-gray-900 dark:text-white">Note</strong> - Additional annotations</span>
                </li>
                <li class="flex items-start gap-2">
                    <i data-lucide="check" class="w-4 h-4 text-gray-400 dark:text-gray-600 flex-shrink-0 mt-0.5"></i>
                    <span><strong class="text-gray-900 dark:text-white">Tags</strong> - Comma-separated tags</span>
                </li>
                <li class="flex items-start gap-2">
                    <i data-lucide="check" class="w-4 h-4 text-gray-400 dark:text-gray-600 flex-shrink-0 mt-0.5"></i>
                    <span><strong class="text-gray-900 dark:text-white">Highlighted at</strong> - When the highlight was created</span>
                </li>
            </ul>
        </div>

        <!-- Progress Bar (hidden by default) -->
        <div id="progress-container" style="display: none;" class="mb-6 p-6 bg-primary-50 dark:bg-primary-900/20 border border-primary-200 dark:border-primary-800 rounded-lg">
            <div class="text-center mb-4">
                <i data-lucide="loader" class="w-10 h-10 mx-auto text-primary-600 dark:text-primary-400 animate-spin mb-3"></i>
                <p class="font-semibold text-primary-900 dark:text-primary-100 text-lg">Importing your highlights...</p>
                <p class="text-sm text-primary-700 dark:text-primary-300 mt-1">Please wait while we process your CSV file</p>
            </div>
            
            <!-- Animated progress bar -->
            <div class="w-full h-3 bg-primary-100 dark:bg-primary-900 rounded-full overflow-hidden border border-primary-200 dark:border-primary-800">
                <div id="progress-bar" class="h-full bg-gradient-to-r from-primary-500 to-primary-600 w-0 transition-all" style="transition: width 0.3s ease;"></div>
            </div>
            <p class="text-center mt-3 text-sm text-primary-700 dark:text-primary-300">
                <span id="progress-text">Starting upload...</span>
            </p>
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-3">
            <button type="submit" id="submit-btn" class="flex items-center gap-2 bg-primary-600 hover:bg-primary-700 dark:bg-primary-600 dark:hover:bg-primary-700 text-white px-6 py-3 rounded-lg font-semibold transition-all hover:shadow-md">
                <i data-lucide="upload" class="w-5 h-5"></i>
                <span>Import Highlights</span>
            </button>
            <a href="/dashboard/ui" class="flex items-center gap-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-900 dark:text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                <i data-lucide="x" class="w-5 h-5"></i>
                <span>Cancel</span>
            </a>
        </div>
    </form>
</div>

<script>
    function showProgress() {
        // Hide form elements
        document.getElementById('submit-btn').disabled = true;
        document.getElementById('submit-btn').style.opacity = '0.5';
        
        // Show progress container
        document.getElementById('progress-container').style.display = 'block';
        
        // Simulate progress
        let progress = 0;
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        
        const messages = [
            'Reading CSV file...',
            'Processing rows...',
            'Creating books...',
            'Importing highlights...',
            'Parsing tags...',
            'Finalizing import...',
            'Import complete!'
        ];
        
        let messageIndex = 0;
        progressText.textContent = messages[0];
        
        const interval = setInterval(() => {
            progress += Math.random() * 12 + 5;
            if (progress > 100) progress = 100;
            
            progressBar.style.width = progress + '%';
            
            // Update message periodically
            const messageThreshold = (messageIndex + 1) * (100 / messages.length);
            if (progress > messageThreshold && messageIndex < messages.length - 1) {
                messageIndex++;
                progressText.textContent = messages[messageIndex];
            }
            
            // Complete - the form submission will navigate to success page
            if (progress >= 100) {
                clearInterval(interval);
                progressText.textContent = 'Import complete! Redirecting...';
            }
        }, 300);
        
        // Store interval ID to clear it if needed
        window.progressInterval = interval;
    }

    // Initialize Lucide icons
    document.addEventListener('DOMContentLoaded', lucide.createIcons);
</script>
{% endblock %}
